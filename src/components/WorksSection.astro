---
import { getCollection } from 'astro:content';
import Hero from './Hero.astro';
import WorkCard from './WorkCard.astro';
import WorkModal from './WorkModal.astro';

// Content Fetching
const allWorks = (await getCollection('work', ({ data }) => {
	return data.draft !== true;
})).sort((a, b) => {
	if (a.data.order !== undefined && b.data.order !== undefined) {
		return a.data.order - b.data.order;
	}
	if (a.data.order !== undefined) return -1;
	if (b.data.order !== undefined) return 1;
	return b.data.publishDate.valueOf() - a.data.publishDate.valueOf()
});

const visualWorks = allWorks.filter(work => work.data.classification === 'visual');
const programmingWorks = allWorks.filter(work => work.data.classification === 'programming');
---

<section id="works"  class="section-space">
	<div class="wrapper stack gap-12 lg:gap-10">

	<header class="hero-center">
	<Hero title="Works" align="center">
		<p class="hero-tagline">
		è‡ªåˆ†ã®ã“ã‚Œã¾ã§ã®æ´»å‹•ãƒ»åˆ¶ä½œå®Ÿç¸¾ã®ç´¹ä»‹ã§ã™ã€‚<br />
		ã‚«ãƒ¼ãƒ‰ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€è©³ç´°ã‚’ã”è¦§ã«ãªã‚Œã¾ã™ã€‚
		</p>
	</Hero>
	</header>

	<section id="programming">
		<h2 class="subsection-title">ğŸ’» Programming / Technical Works</h2>
		<p class="subsection-desc">ç ”ç©¶ãƒ»é–‹ç™ºãƒ»ãƒ„ãƒ¼ãƒ«åˆ¶ä½œãªã©ã€æŠ€è¡“çš„ãªã‚¢ãƒ—ãƒ­ãƒ¼ãƒã«ã‚ˆã‚‹åˆ¶ä½œç‰©ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚</p>
		
		<div class="works-grid">
			{programmingWorks.map((work) => (
				<>
					<WorkCard work={work} />
					<WorkModal work={work} />
				</>
			))}
		</div>
	</section>

	<section id="visual">
		<h2 class="subsection-title">ğŸ¨ 3D Modeling / Visual Works</h2>
		<p class="subsection-desc">Blenderã‚„Unityãªã©ã®3DCGãƒ„ãƒ¼ãƒ«ã‚’ç”¨ã„ã€ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«è¡¨ç¾ã‚„ä¸–ç•Œè¦³ã¥ãã‚Šã«æŒ‘æˆ¦ã—ãŸä½œå“ã‚’ã¾ã¨ã‚ã¦ã„ã¾ã™ã€‚</p>
		
		<div class="works-grid">
			{visualWorks.map((work) => (
				<>
					<WorkCard work={work} />
					<WorkModal work={work} />
				</>
			))}
		</div>
	</section>

	</div>
</section>

<script>
	/* â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
	ã‚«ãƒ¼ãƒ‰ â†” ãƒ¢ãƒ¼ãƒ€ãƒ«é–“ã®ãƒ•ã‚©ãƒ¼ã‚«ã‚¹é·ç§» + Enter/Space å¯¾å¿œ
	â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
	// ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚‚ã“ã“ã«ç§»å‹•
	document.addEventListener('astro:page-load', () => {
		// View Transitionsã‚’ä½¿ã£ã¦ã„ã‚‹å ´åˆã®è€ƒæ…®ï¼ˆä»Šå›ã¯ä½¿ã£ã¦ã„ãªã„ã‹ã‚‚ã—ã‚Œãªã„ãŒå¿µã®ãŸã‚ï¼‰
		initModals();
	});
	
	// é€šå¸¸ã®ãƒ­ãƒ¼ãƒ‰æ™‚ç”¨
	initModals();

	function initModals() {
		const cards = document.querySelectorAll('.work-card[role="button"]');
		let lastFocused: HTMLElement | null = null;

		cards.forEach(card => {
			/* ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ã‚­ãƒ¼æ“ä½œã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã */
			const openModal = () => {
				const modalId = (card as HTMLElement).dataset.modal;
				if (!modalId) return;
				const dlg = document.getElementById(modalId) as HTMLDialogElement;
				if (!dlg) return;
				
				lastFocused = card as HTMLElement;
				dlg.showModal();
				
				// ãƒ¢ãƒ¼ãƒ€ãƒ«å†…ã®å‹•ç”»ã‚’é…å»¶èª­ã¿è¾¼ã¿ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
				const video = dlg.querySelector('video');
				if (video && video.preload === 'none' && video.dataset.src) {
					// å¿…è¦ãªã‚‰ã“ã“ã§srcã‚’ã‚»ãƒƒãƒˆã™ã‚‹å‡¦ç†ã‚’è¿½åŠ å¯
				}

				dlg.focus();
			};

			card.addEventListener('click', openModal);

			/* Enter ã¾ãŸã¯ Space ã§é–‹ã */
			card.addEventListener('keydown', (e: Event) => {
				const keyboardEvent = e as KeyboardEvent;
				if (keyboardEvent.key === 'Enter' || keyboardEvent.key === ' ') {
					e.preventDefault();
					openModal();
				}
			});
		});

		/* ãƒ¢ãƒ¼ãƒ€ãƒ«å´ â€” ã‚¯ãƒªãƒƒã‚¯ / ESC ã§é–‰ã˜ã‚‹ â†’ å…ƒã®ã‚«ãƒ¼ãƒ‰ã«æˆ»ã™ */
		document.querySelectorAll('.work-modal').forEach(dlg => {
			dlg.addEventListener('click', e => {
				const target = e.target as HTMLElement;
				if (target.classList.contains('close') || target === dlg) {
					(dlg as HTMLDialogElement).close();
				}
			});
			dlg.addEventListener('close', () => {
				// é–‰ã˜ãŸã¨ãã«å‹•ç”»ã‚’åœæ­¢ã™ã‚‹
				const video = dlg.querySelector('video');
				if (video) {
					video.pause();
				}
				
				if (lastFocused) lastFocused.focus();
			});
		});
	}
</script>

<style>
	/* index.astro ã‹ã‚‰å¿…è¦ãªã‚¹ã‚¿ã‚¤ãƒ«ã‚’ç§»å‹• */
	.section-space { padding-block: 6rem; }
	.hero-center {
		display: flex;
		flex-direction: column;
		align-items: center;
		text-align: center;
		margin-bottom: 5rem;
	}
	.wrapper { max-width: 1500px; margin-inline: auto; padding-inline: 1rem; }

	.subsection-title {
		font-size: var(--text-2_5xl);
		display: flex;
		align-items: center;
		justify-content: center;
		gap: 0.75rem;
		margin-top: 3rem;
		margin-bottom: 1rem;
		color: var(--gray-100);
		text-align: center;
		border-left: none;
	}
	.subsection-desc {
		font-size: var(--text-md);
		color: var(--gray-400);
		margin-bottom: 2rem;
		text-align: center;
	}

	.works-grid {
		display: flex; 
		flex-direction: column;
		gap: 3rem;
	}
	
	/* Category separator */
	#works section + section {
		margin-top: 4rem;
		border-top: 1px solid var(--gray-800);
		padding-top: 1rem;
	}

	@media (min-width: 50em) {
		.works-grid {
			display: flex;
			grid-template-columns: repeat(3, 1fr);
			gap: 4rem;
		}
	}

	@media (max-width: 40em) {
		.subsection-title {
			font-size: var(--text-2xl);
			margin-top: 2rem;
			margin-bottom: 1rem;
		}
		.subsection-desc {
			font-size: var(--text-base);
			margin-bottom: 2rem;
		}
		.works-grid { gap: 1rem; }
	}
</style>